<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR 物体灵气 (V11.0)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        .tip-box {
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; margin-bottom: 15px;
            text-align: center; backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="tip-box" id="status-text">正在寻找物体...</div>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 10" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <!-- 稍微暗一点的环境光，让发光粒子更明显 -->
        <a-light type="ambient" intensity="0.3"></a-light>
        <a-light type="directional" position="0 1 1" intensity="0.5"></a-light>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- 识别容器 -->
        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0">
            <!-- 
                这里不再放具体的模型，而是作为粒子的发射源 
                position="0 0.5 0" 代表粒子从物体上方中心开始冒出来
            -->
            <a-entity id="particle-emitter" position="0 0 0"></a-entity>
        </a-entity>
    </a-scene>

    <script>
        const statusText = document.getElementById('status-text');
        const anchor = document.getElementById('target-anchor');
        const emitter = document.getElementById('particle-emitter');

        let isTargetFound = false;
        let particleInterval;

        // 颜色库：金色、亮白、浅蓝 (魔法感)
        const colors = ["#FFD700", "#FFFFFF", "#E0FFFF", "#87CEFA", "#FFFACD"];

        anchor.addEventListener("targetFound", () => {
            statusText.innerText = "已识别物体！开始汇聚灵气...";
            isTargetFound = true;
            startParticles();
        });

        anchor.addEventListener("targetLost", () => {
            statusText.innerText = "物体丢失";
            isTargetFound = false;
            stopParticles();
        });

        // 启动粒子系统
        function startParticles() {
            if(particleInterval) clearInterval(particleInterval);
            
            // 每 100毫秒 生成一个新粒子 (看起来连贯)
            particleInterval = setInterval(() => {
                if(!isTargetFound) return;
                createParticle();
            }, 100);
        }

        // 停止粒子系统
        function stopParticles() {
            clearInterval(particleInterval);
            // 可选：清除所有残留粒子
            // emitter.innerHTML = ''; 
        }

        // 创建单个发光粒子
        function createParticle() {
            const el = document.createElement('a-entity');
            
            // 随机颜色
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // 随机大小 (非常小，像星星)
            const size = Math.random() * 0.03 + 0.01;

            // 1. 设置外观 (发光材质)
            // shader: flat (不受光照影响，自己发光)
            el.setAttribute('geometry', { primitive: 'sphere', radius: size });
            el.setAttribute('material', { color: color, shader: 'flat', opacity: 1, transparent: true });

            // 2. 设置初始位置 (随机散落在物体表面区域)
            // 假设物体宽 1米左右，粒子在 x: -0.3~0.3, y: -0.3~0.3 的范围内生成
            const startX = (Math.random() - 0.5) * 0.6;
            const startY = (Math.random() - 0.5) * 0.6;
            // z=0 是贴在物体表面，z=0.1 稍微浮起
            el.setAttribute('position', `${startX} ${startY} 0.1`);

            // 3. 动画：向上漂浮 + 消失
            // MindAR 图片是垂直竖立的，所以 Y轴是上下方向
            // 我们让粒子往 Z轴(垂直纸面) 或者 Y轴(纸面上下) 飘，取决于您的物体怎么摆
            // 假设是杯子上的Logo，我们让粒子 "向外并向上" 飘
            
            // 随机漂浮高度
            const floatHeight = Math.random() * 0.5 + 0.3; 
            
            // 动画配置
            el.setAttribute('animation__move', {
                property: 'position',
                to: `${startX} ${startY + 0.5} ${floatHeight}`, // 向前上方飘
                dur: 2000, // 持续2秒
                easing: 'easeOutSine'
            });

            // 透明度动画 (淡出)
            el.setAttribute('animation__fade', {
                property: 'material.opacity',
                from: 1,
                to: 0,
                dur: 2000,
                easing: 'linear'
            });

            // 4. 自我销毁 (关键！防止内存泄漏)
            // 粒子飘完后，必须把 DOM 删掉，否则手机会卡死
            el.addEventListener('animationcomplete__move', () => {
                el.remove();
            });

            emitter.appendChild(el);
        }
    </script>
</body>
</html>