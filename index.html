<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR ç°åœºè°ƒè¯• (V7.0)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        
        /* 1. è°ƒè¯•æ—¥å¿—æ¡† (å±å¹•é¡¶éƒ¨) */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.7); color: #00ff00; 
            font-family: monospace; font-size: 12px; padding: 10px;
            z-index: 9999; pointer-events: none; overflow-y: scroll;
            box-sizing: border-box;
        }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        .btn {
            background: #FF0000; color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 18px; font-weight: bold;
            pointer-events: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none; 
        }
    </style>
</head>
<body>

    <!-- æ—¥å¿—æ˜¾ç¤ºåŒº -->
    <div id="debug-console">ç­‰å¾…æ“ä½œæ—¥å¿—...<br></div>

    <div id="overlay">
        <button class="btn" id="action-btn">ğŸ›‘ ç‚¹å‡»ç”Ÿæˆ</button>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 10" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" position="0 0 10" intensity="1"></a-light>
        <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>

        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0">
            <a-plane color="red" opacity="0.3" width="1" height="1"></a-plane>
        </a-entity>
    </a-scene>

    <script>
        // æ—¥å¿—å·¥å…·å‡½æ•°
        function log(msg) {
            const box = document.getElementById('debug-console');
            box.innerHTML += `> ${msg}<br>`;
            box.scrollTop = box.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        }

        const scene = document.querySelector('a-scene');
        const actionBtn = document.getElementById('action-btn');
        const anchor = document.getElementById('target-anchor');

        // ç›‘å¬è¯†åˆ«çŠ¶æ€
        anchor.addEventListener("targetFound", event => {
            actionBtn.innerText = "å·²é”å®šï¼ç‚¹å‡»ç”Ÿæˆ";
            actionBtn.style.display = "block";
            log("âœ… è¯†åˆ«æˆåŠŸ (Target Found)");
        });

        anchor.addEventListener("targetLost", event => {
            log("âš ï¸ ç›®æ ‡ä¸¢å¤± (Target Lost)");
        });

        // ç»‘å®šç‚¹å‡»ç”Ÿæˆ
        actionBtn.addEventListener('click', () => {
            log("ğŸ–±ï¸ æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå¼€å§‹æ‰§è¡Œé€»è¾‘...");

            try {
                // 1. åˆ›å»ºç‰©ä½“
                const el = document.createElement('a-entity');
                el.setAttribute('geometry', { primitive: 'box', height: 0.1, width: 0.1, depth: 0.1 }); // åªæœ‰ 10cm å¤§å°
                el.setAttribute('material', { color: 'blue', opacity: 1 });

                // 2. è®¡ç®—åæ ‡
                // ã€é‡è¦ä¿®å¤ã€‘ä½¿ç”¨ AFRAME.THREE è€Œä¸æ˜¯ THREE
                anchor.object3D.updateMatrixWorld(true);
                
                const position = new AFRAME.THREE.Vector3();
                const quaternion = new AFRAME.THREE.Quaternion();
                const scale = new AFRAME.THREE.Vector3();
                
                anchor.object3D.matrixWorld.decompose(position, quaternion, scale);

                log(`ğŸ“ è·å–åˆ°å›¾ç‰‡åæ ‡: ${position.x.toFixed(2)}, ${position.y.toFixed(2)}, ${position.z.toFixed(2)}`);

                // 3. è®¾ç½®ç‰©ä½“ä½ç½® (ç®€å•æµ‹è¯•ï¼šç›´æ¥ç­‰äºå›¾ç‰‡ä½ç½®)
                el.object3D.position.copy(position);
                el.object3D.quaternion.copy(quaternion);

                // 4. æ·»åŠ åˆ°åœºæ™¯
                scene.appendChild(el);
                
                log("ğŸš€ ç”Ÿæˆå®Œæ¯•ï¼å·²æ·»åŠ åˆ° Scene");
                log("ğŸ‘€ è¯·çœ‹å±å¹•çº¢æ¡†é™„è¿‘æœ‰æ²¡æœ‰è“è‰²å°æ–¹å—");

            } catch (e) {
                // å¦‚æœå‡ºé”™ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºçº¢å­—ï¼
                log(`<span style="color:red">âŒ è‡´å‘½é”™è¯¯: ${e.message}</span>`);
            }
        });
    </script>
</body>
</html>