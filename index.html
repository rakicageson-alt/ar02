<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR æ¡Œé¢ç”Ÿæˆ (V4.1 è°ƒè¯•ç‰ˆ)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        .btn {
            background: #07c160;
            color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 18px; font-weight: bold;
            pointer-events: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none; 
        }
    </style>
</head>
<body>

    <div id="overlay">
        <button class="btn" id="action-btn" onclick="spawnShape()">ğŸŒ± ç‚¹å‡»ç”Ÿæˆ</button>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001;" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <a-light type="ambient" intensity="0.8"></a-light>
        <a-light type="directional" position="10 10 10" intensity="1"></a-light>
        <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>

        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0">
            <a-ring color="red" radius-inner="0.5" radius-outer="0.55" opacity="0.5"></a-ring>
        </a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const actionBtn = document.getElementById('action-btn');
        const anchor = document.getElementById('target-anchor');
        let isTargetFound = false;

        anchor.addEventListener("targetFound", event => {
            actionBtn.innerText = "å·²é”å®šï¼ç‚¹å‡»ç”Ÿæˆ";
            actionBtn.style.display = "block";
            isTargetFound = true;
        });

        anchor.addEventListener("targetLost", event => {
            actionBtn.innerText = "ç›®æ ‡ä¸¢å¤± (ä»å¯äº¤äº’)";
        });

        function spawnShape() {
            // è°ƒè¯•æ­¥éª¤ 1: æ£€æŸ¥æ˜¯å¦è¿›å…¥å‡½æ•°
            console.log("ç‚¹å‡»è§¦å‘");

            try {
                const el = document.createElement('a-entity');
                
                // è®¾ç½®ç®€å•çš„ç«‹æ–¹ä½“ (çº¢è‰²)ï¼Œç¡®ä¿æ˜¾çœ¼
                el.setAttribute('geometry', {
                    primitive: 'box',
                    height: 0.3, width: 0.3, depth: 0.3
                });
                el.setAttribute('material', { color: 'red', opacity: 1 });

                // ============================================
                // åæ ‡è®¡ç®— (åŠ äº†å®¹é”™)
                // ============================================
                
                // å¼ºåˆ¶æ›´æ–°çŸ©é˜µï¼Œé˜²æ­¢è·å–åˆ° 0
                anchor.object3D.updateMatrixWorld(true);

                const anchorPos = new THREE.Vector3();
                const anchorQuat = new THREE.Quaternion();
                
                // è·å–å›¾ç‰‡åœ¨ä¸–ç•Œä¸­çš„ä½ç½®
                anchor.object3D.matrixWorld.decompose(anchorPos, anchorQuat, new THREE.Vector3());

                // è°ƒè¯•æ­¥éª¤ 2: çœ‹çœ‹åæ ‡æ˜¯ä¸æ˜¯ (0,0,0)
                if(anchorPos.length() === 0 && !isTargetFound) {
                    alert("è­¦å‘Šï¼šæ— æ³•è·å–å›¾ç‰‡ä½ç½®ï¼Œè¯·ç¡®ä¿æ‘„åƒå¤´æ­£å¯¹ç€å›¾ç‰‡ï¼");
                    return;
                }

                // ç¼©å°éšæœºèŒƒå›´ï¼šåªåœ¨å›¾ç‰‡ä¸­å¿ƒå‘¨å›´ 0.5ç±³ å†…ç”Ÿæˆ
                const randomX = (Math.random() - 0.5) * 0.5; 
                const randomY = (Math.random() - 0.5) * 0.5;
                const fixedZ = 0.05; // ç´§è´´è¡¨é¢

                const offsetVector = new THREE.Vector3(randomX, randomY, fixedZ);
                offsetVector.applyQuaternion(anchorQuat); 
                const finalPos = new THREE.Vector3().addVectors(anchorPos, offsetVector);

                // è®¾ç½®ä½ç½®
                el.object3D.position.copy(finalPos);
                el.object3D.quaternion.copy(anchorQuat);

                // æ·»åŠ åŠ¨ç”»
                el.setAttribute('animation', {
                    property: 'scale', from: '0 0 0', to: '1 1 1', dur: 500, easing: 'easeOutBack'
                });

                scene.appendChild(el);

                // è°ƒè¯•æ­¥éª¤ 3: æˆåŠŸæç¤º
                // å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™ä¸ªå¼¹çª—ï¼Œè¯´æ˜ä»£ç å…¨å¯¹ï¼Œæ˜¯è§†è§‰é—®é¢˜
                // alert(`ç”ŸæˆæˆåŠŸï¼åæ ‡: ${finalPos.x.toFixed(2)}, ${finalPos.y.toFixed(2)}, ${finalPos.z.toFixed(2)}`);

            } catch (e) {
                alert("ä»£ç æŠ¥é”™äº†ï¼š" + e.message);
            }
        }
    </script>
</body>
</html>