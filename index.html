<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR 空间定格 (V6.0)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        .tip-box {
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; margin-bottom: 15px;
            text-align: center; backdrop-filter: blur(4px);
        }
        .btn {
            background: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);
            color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 18px; font-weight: bold;
            pointer-events: auto; 
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4);
            display: none; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="tip-box" id="status-text">正在寻找图片...</div>
        <button class="btn" id="action-btn">✨ 在此处生成模型</button>
    </div>

    <!-- 
      missTolerance: 10 -> 让识别更宽容，不容易丢失
    -->
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 10" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="5 10 7" intensity="1"></a-light>
        
        <!-- 开启 look-controls 以支持脱卡后的旋转追踪 -->
        <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>

        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0">
            <!-- 识别光圈 -->
            <a-ring color="#0072FF" radius-inner="0.5" radius-outer="0.55" opacity="0.5">
                 <a-animation attribute="opacity" from="0.5" to="0.1" dur="1000" dir="alternate" repeat="indefinite"></a-animation>
            </a-ring>
        </a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const statusText = document.getElementById('status-text');
        const actionBtn = document.getElementById('action-btn');
        const anchor = document.getElementById('target-anchor');

        // 几何体库
        const shapes = ['box', 'sphere', 'cylinder', 'dodecahedron'];
        const colors = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#96CEB4"];

        // 绑定点击事件
        actionBtn.addEventListener('click', () => {
            spawnShape();
        });

        // 状态监听
        anchor.addEventListener("targetFound", event => {
            statusText.innerText = "已锁定！点击按钮生成";
            actionBtn.style.display = "block";
        });

        anchor.addEventListener("targetLost", event => {
            // 即使丢失目标，按钮也不隐藏，允许盲操作（可选）
            statusText.innerText = "目标脱离，空间锁定中...";
        });

        function spawnShape() {
            // 创建实体
            const el = document.createElement('a-entity');
            
            // 随机外观
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            const color = colors[Math.floor(Math.random() * colors.length)];

            el.setAttribute('geometry', { primitive: shape, radius: 0.25, height: 0.5, width: 0.5, depth: 0.5 });
            el.setAttribute('material', { color: color, opacity: 0.9, transparent: true, metalness: 0.3 });

            // ==========================================
            // 核心逻辑：计算“世界坐标”并“脱卡”
            // ==========================================
            
            // 1. 强制更新识别图的坐标矩阵
            anchor.object3D.updateMatrixWorld(true);

            // 2. 获取识别图在整个 3D 世界中的绝对位置
            const position = new THREE.Vector3();
            const quaternion = new THREE.Quaternion();
            const scale = new THREE.Vector3();
            anchor.object3D.matrixWorld.decompose(position, quaternion, scale);

            // 3. 计算稍微随机一点的偏移 (散落在纸面上)
            // 偏移量是在“图片坐标系”下的
            const randomX = (Math.random() - 0.5) * 0.8; 
            const randomY = (Math.random() - 0.5) * 1.0; 
            
            // 创建偏移向量 (z=0 代表贴在纸面上，z=0.1 稍微浮起一点点防止闪烁)
            const offset = new THREE.Vector3(randomX, randomY, 0.1);
            
            // 将偏移向量根据图片的旋转角度进行旋转
            offset.applyQuaternion(quaternion);

            // 4. 将旋转后的偏移量加到绝对位置上
            position.add(offset);

            // 5. 将计算好的绝对位置赋值给新物体
            el.object3D.position.copy(position);
            el.object3D.quaternion.copy(quaternion); // 让物体朝向和纸面一致

            // 6. 动画效果
            el.setAttribute('animation__rot', 'property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear');
            el.setAttribute('animation__pop', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');

            // 7. 【关键】挂载到 scene，而不是 anchor
            // 这样图片移走后，物体依然留在计算出的世界坐标处
            scene.appendChild(el);
        }
    </script>
</body>
</html>