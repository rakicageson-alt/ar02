<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR å®Œç¾ç”Ÿæˆ (V9.0)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        /* æ—¥å¿—æ¡† */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.5); color: #00ff00; 
            font-family: monospace; font-size: 12px; padding: 10px;
            z-index: 9999; pointer-events: none; overflow-y: scroll;
        }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 18px; font-weight: bold;
            pointer-events: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none; 
        }
    </style>
</head>
<body>

    <div id="debug-console">ç­‰å¾…æ“ä½œ...<br></div>

    <div id="overlay">
        <button class="btn" id="action-btn">ğŸ² ç”Ÿæˆå‡ ä½•ä½“</button>
    </div>

    <!-- å¢åŠ  far å‚æ•°ï¼Œé˜²æ­¢è¿œè·ç¦»è£å‰ª -->
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 10" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="0 5 5" intensity="1"></a-light>
        
        <!-- å…³é”®ï¼šæŠŠæ‘„åƒæœºè§†è·è®¾ä¸ºæ— é™å¤§ -->
        <a-camera position="0 0 0" look-controls="enabled: true" far="900000"></a-camera>

        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0">
            <a-ring color="#764ba2" radius-inner="0.5" radius-outer="0.55" opacity="0.5"></a-ring>
        </a-entity>
    </a-scene>

    <script>
        function log(msg) {
            const box = document.getElementById('debug-console');
            box.innerHTML += `> ${msg}<br>`;
            box.scrollTop = box.scrollHeight;
        }

        const scene = document.querySelector('a-scene');
        const actionBtn = document.getElementById('action-btn');
        const anchor = document.getElementById('target-anchor');

        const shapes = ['box', 'sphere', 'cylinder', 'cone', 'dodecahedron'];
        const colors = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#96CEB4"];

        anchor.addEventListener("targetFound", () => {
            actionBtn.innerText = "å·²é”å®šï¼ç‚¹å‡»ç”Ÿæˆ";
            actionBtn.style.display = "block";
            log("âœ… è¯†åˆ«æˆåŠŸ");
        });

        anchor.addEventListener("targetLost", () => {
            log("âš ï¸ ç›®æ ‡ä¸¢å¤±");
        });

        actionBtn.addEventListener('click', () => {
            log("ğŸ–±ï¸ å¼€å§‹ç”Ÿæˆ...");

            try {
                // ===============================================
                // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ªâ€œå…‹éš†å®¹å™¨â€ (Wrapper)
                // è¿™ä¸ªå®¹å™¨è´Ÿè´£æ¨¡ä»¿è¯†åˆ«å›¾å½“å‰çš„æ‰€æœ‰çŠ¶æ€
                // ===============================================
                const wrapper = document.createElement('a-entity');
                
                // å¼ºåˆ¶æ›´æ–°çŸ©é˜µï¼Œè·å–æœ€æ–°çš„ä¸–ç•Œåæ ‡æ•°æ®
                anchor.object3D.updateMatrixWorld(true);

                const pos = new AFRAME.THREE.Vector3();
                const rot = new AFRAME.THREE.Quaternion();
                const scale = new AFRAME.THREE.Vector3();

                // æå–è¯†åˆ«å›¾å½“å‰çš„ï¼šä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾
                anchor.object3D.matrixWorld.decompose(pos, rot, scale);

                log(`ğŸ“ é”å®šåæ ‡ Z: ${pos.z.toFixed(0)}`);
                log(`ğŸ“ é”å®šç¼©æ”¾: ${scale.x.toFixed(2)}`); // è¿™é‡Œåº”è¯¥ä¼šæ˜¾ç¤ºå¾ˆå¤§çš„æ•°å­—

                // æŠŠè¿™äº›æ•°æ®èµ‹ç»™å®¹å™¨
                wrapper.object3D.position.copy(pos);
                wrapper.object3D.quaternion.copy(rot);
                wrapper.object3D.scale.copy(scale); // ã€å…³é”®ã€‘ç»§æ‰¿ç¼©æ”¾ï¼Œé˜²æ­¢ç‰©ä½“æ¶ˆå¤±ï¼

                // å°†å®¹å™¨ç›´æ¥æŒ‚è½½åˆ°ä¸–ç•Œåœºæ™¯ (scene)
                scene.appendChild(wrapper);


                // ===============================================
                // ç¬¬äºŒæ­¥ï¼šåœ¨å®¹å™¨é‡Œæ”¾å…¥å‡ ä½•ä½“ (Shape)
                // ===============================================
                const el = document.createElement('a-entity');
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                const color = colors[Math.floor(Math.random() * colors.length)];

                // è®¾ç½®å½¢çŠ¶
                el.setAttribute('geometry', { primitive: shape });
                el.setAttribute('material', { color: color, opacity: 0.9, transparent: true });

                // è®¾ç½®éšæœºæ•£è½ä½ç½® (ç›¸å¯¹äºå®¹å™¨ä¸­å¿ƒ)
                // è¿™é‡Œçš„æ•°å€¼æ˜¯ç›¸å¯¹äºè¯†åˆ«å›¾å°ºå¯¸çš„ (0.5 = å›¾ç‰‡çš„ä¸€åŠå®½åº¦)
                const randX = (Math.random() - 0.5) * 0.8; 
                const randY = (Math.random() - 0.5) * 1.0; 
                
                // Z=0.05 ç¨å¾®æµ®èµ·ä¸€ç‚¹ç‚¹
                el.setAttribute('position', `${randX} ${randY} 0.05`);
                
                // åŠ ä¸Šè‡ªè½¬åŠ¨ç”»
                el.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear');
                el.setAttribute('animation__pop', 'property: scale; from: 0 0 0; to: 0.5 0.5 0.5; dur: 500; easing: easeOutBack');

                // æŠŠå‡ ä½•ä½“æ”¾å…¥å®¹å™¨
                wrapper.appendChild(el);

                log("ğŸš€ ç”Ÿæˆå®Œæ¯•ï¼è¯·ç§»åŠ¨æ‰‹æœºæŸ¥çœ‹æ•ˆæœ");

            } catch (e) {
                log(`âŒ é”™è¯¯: ${e.message}`);
            }
        });
    </script>
</body>
</html>