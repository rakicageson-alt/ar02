<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR æ¡Œé¢ç”Ÿæˆ (V4.0)</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 50px;
        }
        .tip-box {
            background: rgba(0, 0, 0, 0.6); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; margin-bottom: 10px;
            text-align: center; backdrop-filter: blur(4px);
        }
        .btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 18px; font-weight: bold;
            pointer-events: auto; 
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
            display: none; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="tip-box" id="status-text">æ­£åœ¨å¯»æ‰¾hhhå›¾ç‰‡...</div>
        <button class="btn" id="action-btn" onclick="spawnShape()">ğŸŒ± åœ¨å¹³é¢ç”Ÿæˆ</button>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; missTolerance: 5" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">

        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="10 10 10" intensity="0.8"></a-light>

        <a-camera position="0 0 0" look-controls="enabled: true"></a-camera>

        <a-entity id="target-anchor" mindar-image-target="targetIndex: 0">
            <!-- è¯†åˆ«æ—¶çš„æ‰«æå…‰åœˆ -->
            <a-ring color="#38ef7d" radius-inner="0.5" radius-outer="0.55" opacity="0.5">
                <a-animation attribute="opacity" from="0.5" to="0.1" dur="1000" dir="alternate" repeat="indefinite"></a-animation>
            </a-ring>
        </a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const statusText = document.getElementById('status-text');
        const actionBtn = document.getElementById('action-btn');
        const anchor = document.getElementById('target-anchor');

        const shapes = ['box', 'sphere', 'cylinder', 'cone', 'dodecahedron', 'tetrahedron'];
        const colors = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", "#96CEB4", "#FFEEAD"];
        
        let isTargetFound = false;

        anchor.addEventListener("targetFound", event => {
            statusText.innerText = "å·²é”å®šï¼ç‚¹å‡»åœ¨çº¸é¢ä¸Šç”Ÿæˆç‰©ä½“";
            actionBtn.style.display = "block";
            isTargetFound = true;
        });

        anchor.addEventListener("targetLost", event => {
            statusText.innerText = "ç›®æ ‡è„±ç¦»ï¼Œç‰©ä½“å°†åœç•™åœ¨åŸä½...";
        });

        function spawnShape() {
            // ç®€å•æ ¡éªŒ
            if (!isTargetFound && scene.children.length < 5) return alert("è¯·å…ˆæ‰«æå›¾ç‰‡å®šä½ï¼");

            const el = document.createElement('a-entity');
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            const color = colors[Math.floor(Math.random() * colors.length)];

            // 1. è®¾ç½®å‡ ä½•ä½“
            el.setAttribute('geometry', {
                primitive: shape,
                // æŠŠç‰©ä½“åšå°ä¸€ç‚¹ï¼Œçœ‹èµ·æ¥æ›´ç²¾è‡´
                radius: 0.2, 
                height: 0.4,
                width: 0.4,
                depth: 0.4
            });

            // 2. è®¾ç½®æè´¨
            el.setAttribute('material', {
                color: color,
                opacity: 0.9,
                transparent: true,
                metalness: 0.2,
                roughness: 0.5
            });

            // ============================================
            // æ ¸å¿ƒä¿®æ”¹ï¼šè®¡ç®—â€œè´´åœ¨å¹³é¢ä¸Šâ€çš„ä¸–ç•Œåæ ‡
            // ============================================
            
            // A. è·å–è¯†åˆ«å›¾å½“å‰çš„ä¸–ç•Œä½ç½®å’Œæ—‹è½¬è§’åº¦
            const anchorPos = new THREE.Vector3();
            const anchorQuat = new THREE.Quaternion();
            anchor.object3D.updateMatrixWorld();
            anchor.object3D.matrixWorld.decompose(anchorPos, anchorQuat, new THREE.Vector3());

            // B. è®¡ç®—ç›¸å¯¹åç§»é‡ (åœ¨å›¾ç‰‡çš„æœ¬åœ°åæ ‡ç³»ä¸­)
            // X å’Œ Y éšæœº (æ•£è½åœ¨å›¾ç‰‡é¢ä¸Š)
            const randomX = (Math.random() - 0.5) * 1.2; 
            const randomY = (Math.random() - 0.5) * 1.5;
            
            // Z è®¾ä¸º 0 (è¿™å°±æ˜¯â€œè´´åœ¨å¹³é¢ä¸Šâ€çš„å…³é”®)
            // å¦‚æœä½ æƒ³è®©ç‰©ä½“åˆšå¥½ç«‹åœ¨çº¸ä¸Šï¼Œå¯ä»¥è®¾ä¸ºç‰©ä½“é«˜åº¦çš„ä¸€åŠ (æ¯”å¦‚ 0.2)
            const fixedZ = 0.2; 

            // C. åˆ›å»ºä¸€ä¸ªå‘é‡ï¼Œå¹¶åº”ç”¨å›¾ç‰‡çš„æ—‹è½¬
            // è¿™æ ·å³ä½¿å›¾ç‰‡æ˜¯æ–œç€çš„ï¼Œç‰©ä½“ä¹Ÿä¼šæ²¿ç€æ–œé¢ç”Ÿæˆ
            const offsetVector = new THREE.Vector3(randomX, randomY, fixedZ);
            offsetVector.applyQuaternion(anchorQuat); 

            // D. æœ€ç»ˆä¸–ç•Œåæ ‡ = å›¾ç‰‡ä¸­å¿ƒç‚¹ + æ—‹è½¬åçš„åç§»å‘é‡
            const finalPos = new THREE.Vector3().addVectors(anchorPos, offsetVector);

            el.object3D.position.copy(finalPos);
            el.object3D.quaternion.copy(anchorQuat); // è®©ç‰©ä½“çš„æœå‘ä¹Ÿè·Ÿéšå›¾ç‰‡ (å¯é€‰)

            // ============================================

            // 4. éšæœºè‡ªè½¬åŠ¨ç”»
            el.setAttribute('animation__rotate', {
                property: 'rotation',
                to: `${Math.random()*360} ${Math.random()*360} 0`,
                dur: 10000,
                loop: true,
                easing: 'linear'
            });

            // 5. å¼¹å‡ºåŠ¨ç”»
            el.setAttribute('animation__scale', {
                property: 'scale',
                from: '0 0 0',
                to: '1 1 1',
                dur: 600,
                easing: 'easeOutBack'
            });

            scene.appendChild(el);
        }
    </script>
</body>
</html>